{% extends 'base.html' %}{}{% load static %}
{% block title %}
  Dashboard
{% endblock %}

{% block content %}
<!-- dashboard/index.html -->
<head>
    <meta charset="UTF-8">
    <title>System Usage Dashboard</title>

    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/graphs.css' %}">
    <title>System Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2 class="title">/dash</h2>
    <div class="graphs-container">
        <div class="graph">
            <canvas id="cpuChart"></canvas>
        </div>
        <div class="graph">
            <canvas id="memoryChart"></canvas>
        </div>
        <div class="graph">
            <canvas id="networkChart"></canvas>
        </div>
        <div class="graph">
            <canvas id="diskChart"></canvas>
        </div>

    </div>

    <script>
        // Data from Django context
        var data = {{ data|safe }};
        console.log(data);
        var maxDataPoints = 10 * 60; // 10 minutes worth of data if updated every second

        // Initialize the charts
        var cpuChart = createChartPercent(
            'cpuChart', 'CPU Usage (%)', data.cpu_usage.timestamps, data.cpu_usage.values, 'CPU Usage (%)'
        );
        var memoryChart = createChartPercent(
            'memoryChart', 'Memory Usage (%)', data.memory_usage.timestamps, data.memory_usage.values, 'Memory Usage (%)'
        );
        var networkChart = createChartBytes(
            'networkChart', 'Network I/O (MB)', data.network_io.timestamps, data.network_io.values, 'Bytes'
        );
        var diskChart = createChartBytes(
            'diskChart', 'Disk I/O (MB)', data.disk_io.timestamps, data.disk_io.values, 'Bytes'
        );

        // Function to create a chart for percentage data
        function createChartPercent(canvasId, label, dataLabels, dataValues, yLabel) {
            var ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataLabels,
                    datasets: [{
                        label: label,
                        data: dataValues,
                        // borderColor: 'rgba(75, 192, 192, 1)',
                        //fill: false,
                        tension: 0.1,
                        backgroundColor: 'rgba(36, 164, 167, 0.1)', // Light color fill
                        borderColor: 'rgba(36, 164, 167, 1)',     // Border color
                        borderWidth: 2,
                        fill: true,   // Fills the area under the line
                        pointRadius: 0 // Removes the dot
                    }]
                },
                options: {
                    plugins: {
                        title: { display: true, text: label },
                        legend: { display: false }
                    },
                    scales: {
                        x: { display: true, title: { display: true, text: 'Time' } },
                        y: { title: { display: true, text: yLabel } },
                    }
                }
            });
        }

        // Function to create a chart for bytes data
        function createChartBytes(canvasId, label, dataLabels, dataValues, yLabel) {
            let dataValuesInGB = dataValues.map(value => value / (1024 ** 3));
            var ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataLabels,
                    datasets: [{
                        label: label,
                        data: dataValuesInGB,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false,
                        tension: 0.1,
                    }]
                },
                options: {
                    scales: {
                        x: { display: true },
                        y: { display: true },
                    }
                }
            });
        }

        // Function to fetch the latest data and update charts
        function updateChart() {
            fetch('{% url "latest_data" %}')
                .then(response => response.json())
                .then(latestData => {
                    // Update each chart with new data and discard the oldest if over the limit
                    updateChartData(cpuChart, latestData.cpu_usage.timestamp, latestData.cpu_usage.value);
                    updateChartData(memoryChart, latestData.memory_usage.timestamp, latestData.memory_usage.value);
                    updateChartData(networkChart, latestData.network_io.timestamp, latestData.network_io.value);
                    updateChartData(diskChart, latestData.disk_io.timestamp, latestData.disk_io.value);
                })
                .catch(error => console.error('Error fetching latest data:', error));
        }

        // Function to update chart data
        function updateChartData(chart, newTimestamp, newValue) {
            chart.data.labels.push(newTimestamp);
            chart.data.datasets[0].data.push(newValue);

            // Remove oldest data point if exceeding max data points
            if (chart.data.labels.length > maxDataPoints) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.update();
        }

        // Update the chart every minute (60000 milliseconds)
        setInterval(updateChart, 60000);
    </script>
</body>
</html>


{% endblock %}
